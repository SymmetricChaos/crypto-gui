use utils::byte_formatting::ByteFormat;

const SBOX0: [u32; 256] = [
    1077968896, 4227072, 1077968900, 268503108, 4261892, 272664580, 1073743876, 4259904,
    1342275584, 268535812, 272730116, 1077970948, 268503104, 1342275652, 1346371652, 1077968960,
    1342242884, 4292672, 1346437184, 1073807424, 268435456, 272697412, 1073774592, 1077938244,
    98304, 1073807364, 268503044, 272730176, 1078003776, 4259844, 1078001732, 2116, 4292612, 65536,
    1073776708, 1078001664, 67648, 4194372, 268500992, 1346371648, 1073741892, 268533764, 4261956,
    1342242816, 98368, 34816, 1346472004, 268437508, 4196416, 1342212100, 1342244928, 1342277632,
    1073842240, 272664644, 1342179392, 268437572, 268535876, 4194368, 272631812, 1342242880,
    272730180, 1342210048, 268470272, 1077936128, 32772, 4227076, 268468288, 4227136, 4194308,
    32768, 1346469892, 4, 1346406400, 1073741824, 268435524, 268437504, 1078036544, 32836, 4227140,
    272631808, 1346437120, 1073807360, 268470340, 1073840128, 1342177348, 1077970944, 1078036548,
    1346439232, 4294660, 272697344, 1077938240, 272695364, 268533824, 1342212096, 1077936196,
    4292608, 272629828, 1073743940, 1342212160, 64, 98308, 4259840, 272664640, 1346472000,
    1073741828, 1342277700, 272631872, 4292676, 4196352, 272631876, 1078034432, 272662532,
    1346404356, 1346373696, 1342277696, 34880, 65540, 1342244868, 1077938176, 4229184, 268533828,
    1073774660, 1346406464, 1342210112, 268501056, 1073840132, 1342179328, 272662592, 1073743936,
    1077936132, 4261888, 272695296, 1346439168, 1346373636, 1078001728, 268500996, 268533760,
    1342242820, 98372, 1342275648, 1346471936, 1073807428, 1346404416, 268535808, 1346371588,
    272662528, 272697408, 272662596, 2052, 1078036480, 4294720, 1073741888, 4259908, 272695300,
    1073842180, 272629760, 4229188, 1073776644, 1073776640, 0, 34820, 1077936192, 268468292,
    1346406468, 1342244864, 1073774596, 4196420, 1346371584, 2048, 1346437188, 67588, 1342177344,
    1077971008, 272728132, 1077968964, 1342212164, 1078003712, 100416, 1078001668, 1346373700,
    272629824, 4294656, 1073774656, 1078034436, 1342210052, 268535872, 268501060, 65604, 268435520,
    1346437124, 1073809408, 272629764, 1078003780, 1342277636, 268470276, 272728128, 268468224,
    1342179332, 272664576, 4229124, 1078034500, 4261952, 1346469888, 68, 1346469956, 268435460,
    1342179396, 1073840192, 1346404420, 2112, 1346404352, 1077971012, 1073809476, 1073840196,
    65600, 4196356, 272728064, 67652, 32832, 1346373632, 1073809412, 1342210116, 1342177280,
    1073776704, 1342177284, 268470336, 1073809472, 4229120, 272697348, 1342275588, 1078036484,
    1078003716, 1342244932, 268468228, 1073842244, 100420, 272728068, 67584, 34884, 1346406404,
    268503040, 1346439236, 1073842176, 1346471940, 1346469952, 272730112, 1346439172, 4194304,
    1077938180, 272695360, 1078034496, 1073743872, 4294724, 100356, 268437568, 100352,
];

const SBOX1: [u32; 256] = [
    2148008448, 524800, 2148008450, 69206290, 2621698, 67633922, 2147483906, 2621456, 2216690176,
    69206786, 69731074, 2148008706, 69206288, 2216690194, 2215116818, 2148008464, 2216689682,
    2621968, 2217213968, 2149580816, 67108864, 69730578, 2147484160, 2148008210, 2097664,
    2149580802, 69206274, 69731088, 2150105360, 2621442, 2150105106, 274, 2621954, 2097152,
    2147484434, 2150105088, 2097424, 524306, 69206016, 2215116816, 2147483666, 69206530, 2621714,
    2216689664, 2097680, 768, 2217214738, 67109122, 524560, 2214593282, 2216689936, 2216690432,
    2149581584, 67633938, 2214592784, 67109138, 69206802, 524304, 67633410, 2216689680, 69731090,
    2214593024, 67109632, 2148007936, 514, 524802, 67109392, 524816, 524290, 512, 2217214466, 2,
    2215117568, 2147483648, 67108882, 67109120, 2150105872, 530, 524818, 67633408, 2217213952,
    2149580800, 67109650, 2149581312, 2214592530, 2148008704, 2150105874, 2217214224, 2622210,
    69730560, 2148008208, 69730322, 69206544, 2214593280, 2148007954, 2621952, 67633170,
    2147483922, 2214593296, 16, 2097666, 2621440, 67633936, 2217214736, 2147483650, 2216690450,
    67633424, 2621970, 524544, 67633426, 2150105600, 67633666, 2215117314, 2215117072, 2216690448,
    784, 2097154, 2216689922, 2148008192, 525072, 69206546, 2147484178, 2215117584, 2214593040,
    69206032, 2149581314, 2214592768, 67633680, 2147483920, 2148007938, 2621696, 69730304,
    2217214208, 2215117058, 2150105104, 69206018, 69206528, 2216689666, 2097682, 2216690192,
    2217214720, 2149580818, 2215117328, 69206784, 2215116802, 67633664, 69730576, 67633682, 258,
    2150105856, 2622224, 2147483664, 2621458, 69730306, 2149581570, 67633152, 525074, 2147484418,
    2147484416, 0, 770, 2148007952, 67109394, 2215117586, 2216689920, 2147484162, 524562,
    2215116800, 256, 2217213970, 2097410, 2214592528, 2148008720, 69730834, 2148008466, 2214593298,
    2150105344, 2097936, 2150105090, 2215117074, 67633168, 2622208, 2147484176, 2150105602,
    2214593026, 69206800, 69206034, 2097170, 67108880, 2217213954, 2149581056, 67633154,
    2150105362, 2216690434, 67109634, 69730832, 67109376, 2214592770, 67633920, 525058, 2150105618,
    2621712, 2217214464, 18, 2217214482, 67108866, 2214592786, 2149581328, 2215117330, 272,
    2215117312, 2148008722, 2149581074, 2149581330, 2097168, 524546, 69730816, 2097426, 528,
    2215117056, 2149581058, 2214593042, 2214592512, 2147484432, 2214592514, 67109648, 2149581072,
    525056, 69730562, 2216690178, 2150105858, 2150105346, 2216689938, 67109378, 2149581586,
    2097938, 69730818, 2097408, 786, 2215117570, 69206272, 2217214226, 2149581568, 2217214722,
    2217214480, 69731072, 2217214210, 524288, 2148008194, 69730320, 2150105616, 2147483904,
    2622226, 2097922, 67109136, 2097920,
];

const SBOX2: [u32; 256] = [
    142610432, 8392704, 142610560, 33824928, 8659072, 41955456, 134226048, 8650784, 168038400,
    33828992, 42217600, 142618752, 33824800, 168038560, 176160928, 142610464, 168034464, 8654880,
    176422944, 134479904, 33554432, 42213536, 134221824, 142614688, 266240, 134480000, 33824896,
    42217504, 142876704, 8650880, 142868640, 8352, 8654976, 262144, 134230176, 142868480, 270368,
    8388768, 33816576, 176160800, 134217888, 33820800, 8659104, 168034304, 266272, 12288,
    176435360, 33562752, 8396832, 167784576, 168042528, 168046592, 134492192, 41955488, 167780384,
    33562784, 33829024, 8388640, 41951360, 168034336, 42217632, 167776256, 33566720, 142606336,
    4224, 8392832, 33558560, 8392736, 8388736, 4096, 176427136, 128, 176173056, 134217728,
    33554592, 33562624, 142880800, 4256, 8392864, 41951232, 176422912, 134479872, 33566880,
    134483968, 167772320, 142618624, 142880928, 176431136, 8663168, 42213376, 142614560, 42205344,
    33820704, 167784448, 142606496, 8654848, 41943200, 134226080, 167784480, 32, 266368, 8650752,
    41955360, 176435232, 134217856, 168046752, 41951264, 8655008, 8396800, 41951392, 142872576,
    41947264, 176164992, 176168992, 168046624, 12320, 262272, 168042624, 142614528, 8400928,
    33820832, 134221984, 176173088, 167776288, 33816608, 134484096, 167780352, 41947168, 134225952,
    142606464, 8658944, 42205184, 176431104, 176169088, 142868512, 33816704, 33820672, 168034432,
    266400, 168038432, 176435200, 134480032, 176164896, 33828864, 176160896, 41947136, 42213408,
    41947296, 8320, 142880768, 8663072, 134217760, 8650912, 42205312, 134492288, 41943040, 8401056,
    134230144, 134230016, 0, 12416, 142606368, 33558688, 176173216, 168042496, 134221952, 8396960,
    176160768, 8192, 176423072, 270464, 167772192, 142618656, 42209440, 142610592, 167784608,
    142876672, 274464, 142868608, 176169120, 41943072, 8663040, 134221856, 142872704, 167776384,
    33828896, 33816736, 262304, 33554464, 176423040, 134488064, 41943168, 142876832, 168046720,
    33566848, 42209312, 33558528, 167780480, 41955328, 8401024, 142872736, 8658976, 176427008, 160,
    176427168, 33554560, 167780512, 134484000, 176165024, 8224, 176164864, 142618784, 134488224,
    134484128, 262176, 8396928, 42209280, 270496, 4128, 176168960, 134488192, 167776416, 167772160,
    134230048, 167772288, 33566752, 134488096, 8400896, 42213504, 168038528, 142880896, 142876800,
    168042656, 33558656, 134492320, 274592, 42209408, 270336, 12448, 176173184, 33824768,
    176431264, 134492160, 176435328, 176427040, 42217472, 176431232, 8388608, 142614656, 42205216,
    142872608, 134225920, 8663200, 274560, 33562656, 274432,
];

const SBOX3: [u32; 256] = [
    537018368, 147456, 537018376, 17826825, 1180680, 16925704, 536871944, 1179649, 554713088,
    17843208, 17974280, 537019400, 17826817, 554713097, 553779209, 537018369, 554696713, 1196033,
    554827777, 537919489, 16777216, 17957897, 536887296, 537003017, 1064960, 537919496, 17826824,
    17974273, 538051585, 1179656, 538050569, 1033, 1196040, 1048576, 536888329, 538050560, 1049601,
    131081, 17825792, 553779201, 536870921, 17842184, 1180681, 554696704, 1064961, 17408,
    554845193, 16778248, 132097, 553665544, 554697729, 554714112, 537936897, 16925705, 553649153,
    16778249, 17843209, 131073, 16909320, 554696705, 17974281, 553664512, 16794624, 537001984,
    16392, 147464, 16793601, 147457, 131080, 16384, 554844168, 8, 553796608, 536870912, 16777225,
    16778240, 538067969, 16393, 147465, 16909312, 554827776, 537919488, 16794633, 537935872,
    553648137, 537019392, 538067977, 554828801, 1197064, 17957888, 537003009, 17956873, 17842177,
    553665536, 537001993, 1196032, 16908297, 536871945, 553665537, 1, 1064968, 1179648, 16925697,
    554845185, 536870920, 554714121, 16909313, 1196041, 132096, 16909321, 538066944, 16924680,
    553795592, 553780225, 554714113, 17409, 1048584, 554697736, 537003008, 148481, 17842185,
    536887305, 553796609, 553664513, 17825793, 537935880, 553649152, 16924673, 536871937,
    537001992, 1180672, 17956864, 554828800, 553780232, 538050561, 17825800, 17842176, 554696712,
    1064969, 554713089, 554845184, 537919497, 553795585, 17843200, 553779208, 16924672, 17957889,
    16924681, 1032, 538067968, 1197057, 536870913, 1179657, 17956872, 537936904, 16908288, 148489,
    536888328, 536888320, 0, 17416, 537001985, 16793609, 553796617, 554697728, 536887304, 132105,
    553779200, 1024, 554827785, 1049608, 553648129, 537019393, 17973257, 537018377, 553665545,
    538051584, 1065985, 538050568, 553780233, 16908289, 1197056, 536887297, 538066952, 553664520,
    17843201, 17825801, 1048585, 16777217, 554827784, 537920512, 16908296, 538051593, 554714120,
    16794632, 17973249, 16793600, 553649160, 16925696, 148488, 538066953, 1180673, 554844160, 9,
    554844169, 16777224, 553649161, 537935873, 553795593, 1025, 553795584, 537019401, 537920521,
    537935881, 1048577, 132104, 17973248, 1049609, 16385, 553780224, 537920520, 553664521,
    553648128, 536888321, 553648136, 16794625, 537920513, 148480, 17957896, 554713096, 538067976,
    538051592, 554697737, 16793608, 537936905, 1065993, 17973256, 1049600, 17417, 553796616,
    17826816, 554828809, 537936896, 554845192, 554844161, 17974272, 554828808, 131072, 537003016,
    17956865, 538066945, 536871936, 1197065, 1065992, 16778241, 1065984,
];

fn sbox(n: u32) -> u32 {
    SBOX0[n as usize & 0xff]
        | SBOX1[(n as usize) >> 8 & 0xff]
        | SBOX2[(n as usize) >> 16 & 0xff]
        | SBOX3[(n as usize) >> 24 & 0xff]
}

pub struct WordLfsr {
    words: [u32; 16],
}

impl WordLfsr {
    pub fn step(&mut self) {
        todo!()
    }
}

pub struct Fsm {
    r1: u32,
    r2: u32,
}

impl Fsm {
    pub fn step(&mut self, s1: u32) -> u32 {
        let out = s1.wrapping_add(self.r1) ^ self.r2;
        let temp = out.wrapping_add(self.r2).rotate_left(7) ^ self.r1;
        self.r2 = sbox(self.r1);
        self.r1 = temp;
        out
    }
}

pub struct Snow1 {
    pub input_format: ByteFormat,
    pub output_format: ByteFormat,
    lfsr: WordLfsr,
    fsm: Fsm,
}

impl Default for Snow1 {
    fn default() -> Self {
        Self {
            input_format: ByteFormat::Hex,
            output_format: ByteFormat::Hex,
            lfsr: WordLfsr { words: [0; 16] },
            fsm: Fsm { r1: 0, r2: 0 },
        }
    }
}

impl Snow1 {
    pub fn with_key_128(mut self, key: [u32; 4]) -> Self {
        self.lfsr.words[0] = key[0];
        self.lfsr.words[1] = key[1];
        self.lfsr.words[2] = key[2];
        self.lfsr.words[3] = key[3];

        self.lfsr.words[4] = key[0] ^ 1;
        self.lfsr.words[5] = key[1] ^ 1;
        self.lfsr.words[6] = key[2] ^ 1;
        self.lfsr.words[7] = key[3] ^ 1;

        self.lfsr.words[8] = key[0];
        self.lfsr.words[9] = key[1];
        self.lfsr.words[10] = key[2];
        self.lfsr.words[11] = key[3];

        self.lfsr.words[12] = key[0] ^ 1;
        self.lfsr.words[13] = key[1] ^ 1;
        self.lfsr.words[14] = key[2] ^ 1;
        self.lfsr.words[15] = key[3] ^ 1;

        self.fsm.r1 = 0;
        self.fsm.r2 = 0;

        self
    }

    pub fn with_key_256(mut self, key: [u32; 8]) -> Self {
        self.lfsr.words[0] = key[0];
        self.lfsr.words[1] = key[1];
        self.lfsr.words[2] = key[2];
        self.lfsr.words[3] = key[3];
        self.lfsr.words[4] = key[4];
        self.lfsr.words[5] = key[5];
        self.lfsr.words[6] = key[6];
        self.lfsr.words[7] = key[7];

        self.lfsr.words[8] = key[0] ^ 1;
        self.lfsr.words[9] = key[1] ^ 1;
        self.lfsr.words[10] = key[2] ^ 1;
        self.lfsr.words[11] = key[3] ^ 1;
        self.lfsr.words[12] = key[4] ^ 1;
        self.lfsr.words[13] = key[5] ^ 1;
        self.lfsr.words[14] = key[6] ^ 1;
        self.lfsr.words[15] = key[7] ^ 1;

        self.fsm.r1 = 0;
        self.fsm.r2 = 0;

        self
    }

    pub fn encrypt_bytes(&self, bytes: &mut [u8]) {
        todo!()
    }

    pub fn encrypt_bytes_mut(&mut self, bytes: &mut [u8]) {
        todo!()
    }
}

crate::impl_cipher_for_stream_cipher!(Snow1);
